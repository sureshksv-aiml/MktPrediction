---
globs: *.py
alwaysApply: false
---
# Python Prefer Config Over os.getenv - Use Configuration Module

## Context
Direct usage of `os.getenv()` for configuration values leads to:
- Scattered configuration logic throughout the codebase
- No central source of truth for configuration
- Difficult configuration validation and type safety
- Inconsistent default values across the application
- Harder to track what environment variables are actually used
- No ability to validate configuration at startup

Using a centralized config module provides better maintainability, type safety, and allows for proper configuration validation.

## Rule
1. **Never use** `os.getenv()` directly in service files, utilities, or business logic.
2. **Always use** the centralized config module (`from ..config import config`).
3. **Define all environment variables** in the config module with proper defaults.
4. **Use config attributes** instead of environment variable names directly.
5. **Only use `os.getenv()`** within the config module itself or for temporary/deployment scripts.

## Configuration Architecture

### ✅ Centralized Config Module Pattern
```python
# config.py - ONLY place for os.getenv() usage
import os

class Config:
    # Google Cloud settings
    GOOGLE_CLOUD_PROJECT: str = os.getenv("GOOGLE_CLOUD_PROJECT", "")
    GOOGLE_CLOUD_REGION: str = os.getenv("GOOGLE_CLOUD_REGION", "us-central1")
    
    # Aliases for consistency
    PROJECT_ID: str = GOOGLE_CLOUD_PROJECT
    VERTEX_AI_LOCATION: str = GOOGLE_CLOUD_REGION
    
    # Server settings
    PORT: int = int(os.getenv("PORT", "8080"))
    HOST: str = os.getenv("HOST", "0.0.0.0")
    
    # AI/ML settings
    TEXT_EMBEDDING_MODEL: str = os.getenv("TEXT_EMBEDDING_MODEL", "text-embedding-004")
    TEXT_EMBEDDING_DIMENSIONS: int = int(os.getenv("TEXT_EMBEDDING_DIMENSIONS", "768"))

# Global config instance
config = Config()
```

### ✅ Service Usage Pattern
```python
# services/image_analysis_service.py
from ..config import config

class ImageAnalysisService:
    def __init__(self, project_id: str | None = None):
        self.project_id = project_id or config.PROJECT_ID
        self.location = config.VERTEX_AI_LOCATION
```

## Examples

### ❌ Bad (Direct os.getenv usage)
```python
# services/processing_service.py
import os

class ProcessingService:
    def __init__(self, project_id: str | None = None):
        # BAD: Direct environment variable access
        self.project_id = project_id or os.getenv("GOOGLE_CLOUD_PROJECT")
        
def get_embedding_service():
    # BAD: Scattered configuration logic
    text_model = os.getenv("TEXT_EMBEDDING_MODEL", "text-embedding-004")
    dimensions = int(os.getenv("TEXT_EMBEDDING_DIMENSIONS", "768"))
    return EmbeddingService(text_model, dimensions)

# utils/server.py
def start_server():
    # BAD: No centralized defaults
    host = os.getenv("HOST", "0.0.0.0")
    port = int(os.getenv("PORT", "8000"))  # Different default than config!
```

### ✅ Good (Using config module)
```python
# services/processing_service.py
from ..config import config

class ProcessingService:
    def __init__(self, project_id: str | None = None):
        # GOOD: Uses centralized config
        self.project_id = project_id or config.PROJECT_ID
        
def get_embedding_service():
    # GOOD: All config from one place
    return EmbeddingService(
        text_model=config.TEXT_EMBEDDING_MODEL,
        dimensions=config.TEXT_EMBEDDING_DIMENSIONS
    )

# utils/server.py
from ..config import config

def start_server():
    # GOOD: Consistent with centralized config
    host = config.HOST
    port = config.PORT
```

## Benefits of Centralized Config

### Development Benefits
- **Single source of truth** for all configuration
- **Type safety** with proper type annotations
- **Consistent defaults** across the entire application
- **Easy testing** with config mocking
- **IDE autocompletion** for configuration values

### Production Benefits
- **Configuration validation** at startup
- **Better error messages** when config is missing
- **Easier deployment** with clear environment variable requirements
- **Reduced runtime errors** from missing environment variables

## Config Module Best Practices

### 1. Group Related Settings
```python
class Config:
    # Google Cloud settings
    GOOGLE_CLOUD_PROJECT: str = os.getenv("GOOGLE_CLOUD_PROJECT", "")
    VERTEX_AI_LOCATION: str = os.getenv("GOOGLE_CLOUD_REGION", "us-central1")
    
    # Database settings
    DATABASE_URL: str = os.getenv("DATABASE_URL", "")
    DATABASE_POOL_SIZE: int = int(os.getenv("DATABASE_POOL_SIZE", "20"))
```

### 2. Provide Type Annotations
```python
class Config:
    PORT: int = int(os.getenv("PORT", "8080"))
    DEBUG: bool = os.getenv("DEBUG", "false").lower() == "true"
    TIMEOUT: float = float(os.getenv("TIMEOUT", "30.0"))
```

### 3. Add Configuration Validation
```python
class Config:
    @classmethod
    def validate(cls) -> dict[str, Any]:
        """Validate configuration and return status."""
        missing: list[str] = []
        
        if not cls.GOOGLE_CLOUD_PROJECT:
            missing.append("GOOGLE_CLOUD_PROJECT")
        if not cls.DATABASE_URL:
            missing.append("DATABASE_URL")
            
        return {
            "valid": len(missing) == 0,
            "missing": missing,
        }
```

## Acceptable os.getenv() Usage

### ✅ Allowed in Config Module
```python
# config.py - ONLY place for os.getenv()
class Config:
    PROJECT_ID: str = os.getenv("GOOGLE_CLOUD_PROJECT", "")
```

### ✅ Allowed in Deployment Scripts
```python
# deploy.py or similar deployment utilities
def deploy():
    trigger_name = os.getenv("TRIGGER_NAME", "default-trigger")
```

### ✅ Allowed for Environment Detection
```python
# For simple environment checks in utils
def is_development() -> bool:
    return os.getenv("ENVIRONMENT", "production").lower() == "development"
```

## Migration Strategy

### 1. Identify All os.getenv() Usage
```bash
# Find all os.getenv usage
grep -r "os\.getenv" . --include="*.py"
```

### 2. Add Missing Config Values
For each `os.getenv()` found, add it to the config module:
```python
# Add to config.py
NEW_SETTING: str = os.getenv("NEW_SETTING", "default_value")
```

### 3. Replace Direct Usage
```python
# Before
value = os.getenv("NEW_SETTING", "default_value")

# After
from ..config import config
value = config.NEW_SETTING
```

### 4. Remove os Import (if no longer needed)
```python
# Remove if no other os usage
import os  # Remove this line
```

## Common Patterns

### Service Initialization
```python
# Pattern for services that need config
from ..config import config

class MyService:
    def __init__(self, project_id: str | None = None):
        self.project_id = project_id or config.PROJECT_ID
        self.location = config.VERTEX_AI_LOCATION
```

### Factory Functions
```python
# Pattern for factory functions
from ..config import config

def get_my_service():
    return MyService(
        model=config.MY_MODEL,
        dimensions=config.MY_DIMENSIONS,
        project_id=config.PROJECT_ID
    )
```

## Checklist for the Assistant
- [ ] Never suggest `os.getenv()` in service files or business logic
- [ ] Always import and use the config module (`from ..config import config`)
- [ ] Add new environment variables to the config module first
- [ ] Use config attributes instead of environment variable names
- [ ] Ensure consistent defaults through the config module
- [ ] Validate that imports are correct (`from ..config import config`)
- [ ] Remove unused `import os` statements after replacing os.getenv()

This ensures centralized, type-safe configuration management with better maintainability and fewer runtime errors.
